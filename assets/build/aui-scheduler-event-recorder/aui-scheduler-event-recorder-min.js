YUI.add("aui-scheduler-event-recorder",function(e,t){var n=e.Lang,r=n.isArray,i=n.isObject,s=n.isString,o=n.isUndefined,u=e.IO.prototype._serialize,a=function(e,t,n){return Math.min(Math.max(e,t),n)},f=e.DataType.DateMath,l="-",c=".",h="",p=" ",d="scheduler-event",v="scheduler-event-recorder",m="activeView",g="arrow",y="body",b="bodyContent",w="boundingBox",E="cancel",S="click",x="content",T="date",N="dateFormat",C="delete",k="endDate",L="event",A="footerContent",O="form",M="header",_="isoTime",D="keydown",P="node",H="offsetHeight",B="offsetWidth",j="overlay",F="recorder",I="rendered",q="save",R="scheduler",U="schedulerChange",z="shadow",W="startDate",X="strings",V="submit",$="template",J="toolbar",K="top",Q="visibleChange",G=e.getClassName,Y=G(d),Z=G(d,F),et=G(R,L,F,j),tt=G(R,L,F,j,g),nt=G(R,L,F,j,g,K),rt=G(R,L,F,j,g,z),it=G(R,L,F,j,y),st=G(R,L,F,j,x),ot=G(R,L,F,j,T),ut=G(R,L,F,j,O),at=G(R,L,F,j,M),ft=['<div class="',rt," ",tt,'"></div>','<div class="',tt,'"></div>','<input type="hidden" name="startDate" value="{startDate}" />','<input type="hidden" name="endDate" value="{endDate}" />','<div class="',at,'">','<input class="',st,'" name="content" value="{content}" />',"</div>",'<div class="',it,'">','<label class="',ot,'">{date}</label>',"</div>"],lt='<form class="'+ut+'" id="schedulerEventRecorderForm"></form>',ct=e.Component.create({NAME:v,ATTRS:{allDay:{value:!1},content:{},duration:{value:60},dateFormat:{validator:s,value:"%a, %B %d,"},event:{},eventClass:{valueFn:function(){return e.SchedulerEvent}},strings:{value:{},setter:function(t){return e.merge({"delete":"Delete","description-hint":"e.g., Dinner at Brian's",cancel:"Cancel",description:"Description",edit:"Edit",save:"Save",when:"When"},t||{})},validator:i},overlay:{validator:i,value:{constrain:!0,visible:!1,width:300,zIndex:500}},overlayOffset:{value:[15,-38],validator:r},template:{value:ft},toolbar:{setter:function(t){var n=this,r=n.get(X);return e.merge({children:[[{label:r[q],on:{click:e.bind(n._handleSaveEvent,n)}},{label:r[E],on:{click:e.bind(n._handleCancelEvent,n)}},{label:r[C],on:{click:e.bind(n._handleDeleteEvent,n)}}]]},t||{})},validator:i,value:{}}},EXTENDS:e.SchedulerEvent,prototype:{initializer:function(){var t=this;t.get(P).addClass(Z),t.publish("cancel",{defaultFn:t._defCancelEventFn}),t.publish("delete",{defaultFn:t._defDeleteEventFn}),t.publish("edit",{defaultFn:t._defEditEventFn}),t.publish("save",{defaultFn:t._defSaveEventFn}),t.after(U,t._afterSchedulerChange),t[j]=new e.Overlay(t.get(j)),t[J]=new e.Toolbar(t.get(J)),t[j].on(Q,e.bind(t._onOverlayVisibleChange,t))},getOverlayContentNode:function(){var e=this,t=e[j].get(w);return t.one(c+st)},getUpdatedSchedulerEvent:function(t){var n=this,r=n.get(L),i={silent:!r},s=n.serializeForm();return r||(r=n.clone()),r.set(R,n.get(R),{silent:!0}),r.setAttrs(e.merge(s,t),i),r},_afterSchedulerChange:function(t){var n=this,r=t.newVal,i=r.get(w);i.delegate(S,e.bind(n._onClickSchedulerEvent,n),c+Y)},_defCancelEventFn:function(e){var t=this;t.get(P).remove(),t.hideOverlay()},_defDeleteEventFn:function(e){var t=this,n=t.get(R);n.removeEvents(t.get(L)),t.hideOverlay(),n.syncEventsUI()},_defEditEventFn:function(e){var t=this,n=t.get(R);t.hideOverlay(),n.syncEventsUI()},_defSaveEventFn:function(e){var t=this,n=t.get(R);n.addEvents(e.newSchedulerEvent),t.hideOverlay(),n.syncEventsUI()},_handleCancelEvent:function(e){var t=this;t.fire("cancel"),e.preventDefault()},_handleClickOutSide:function(e){var t=this;t.fire("cancel")},_handleDeleteEvent:function(e){var t=this;t.fire("delete",{schedulerEvent:t.get(L)}),e.preventDefault()},_handleEscapeEvent:function(t){var n=this;n[j].get(I)&&t.keyCode==e.Event.KeyMap.ESC&&(n.fire("cancel"),t.preventDefault())},_handleSaveEvent:function(e){var t=this,n=t.get(L)?"edit":"save";t.fire(n,{newSchedulerEvent:t.getUpdatedSchedulerEvent()}),e.preventDefault()},_onClickSchedulerEvent:function(e){var t=this,n=e.currentTarget.getData(d);n&&(t.set(L,n,{silent:!0}),t.showOverlay([e.pageX,e.pageY]),t.get(P).remove())},_onOverlayVisibleChange:function(e){var t=this;if(e.newVal){t.populateForm();if(!t.get(L)){var n=t.getOverlayContentNode();n&&setTimeout(function(){n.selectText()},0)}}else t.set(L,null,{silent:!0}),t.get(P).remove()},_onSubmitForm:function(e){var t=this;t._handleSaveEvent(e)},_renderOverlay:function(){var t=this,n=t.get(R),r=n.get(w),i=t.get(X);t[j].render(r),t[J].render(r);var s=t[j].get(w);s.addClass(et),t[j].set(A,t[J].get(w)),t.formNode=e.Node.create(lt),t[j].set(b,t.formNode),t.formNode.on(V,e.bind(t._onSubmitForm,t)),n.get(w).on("clickoutside",e.bind(t._handleClickOutSide,t))},getFormattedDate:function(){var e=this,t=e.get(N),n=e.get(L)||e,r=n.get(k),i=n.get(R),s=n.get(W),o=i.get(m).get(_)?f.toIsoTimeString:f.toUsTimeString;return[n._formatDate(s,t),o(s),l,o(r)].join(p)},getTemplateData:function(){var e=this,t=e.get(X),n=e.get(L)||e,r=n.get(x);return o(r)&&(r=t["description-hint"]),{content:r,date:e.getFormattedDate(),endDate:n.get(k).getTime(),startDate:n.get(W).getTime()}},hideOverlay:function(){var e=this;e[j].hide()},populateForm:function(){var t=this,n=t.get($).join(h);t.formNode.setContent(e.Lang.sub(n,t.getTemplateData()))},serializeForm:function(){var t=this;return e.QueryString.parse(u(t.formNode.getDOM()))},showOverlay:function(t){var n=this,r=t.concat([]),i=n[j],s=i.get(w);n[j].get(I)||n._renderOverlay(),i.show(),n.handleEscapeEvent=e.on(D,e.bind(n._handleEscapeEvent,n));var o=s.all(c+tt),u=o.item(0),f=u.get(H),l=u.get(B);o.removeClass(nt).show(),t[0]-=s.get(B)*.5,t[1]-=s.get(H)+f*.5;var h=i.getConstrainedXY(t);h[1]!==t[1]&&(t[1]=r[1]+f*.5,o.addClass(nt)),t=i.getConstrainedXY(t),i.set("xy",t);var p=a(r[0]-l*.5,t[0],t[0]+s.get(B));o.setX(p)}}});e.SchedulerEventRecorder=ct},"2.0.0pr5",{requires:["querystring","io-form","overlay","aui-scheduler-base","aui-toolbar"],skinnable:!0});
